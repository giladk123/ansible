# AWS playbook
---

- name: Create spot instace request
  hosts: localhost
  connection: local
  
   
  tasks:
    - name: Get instance info
      amazon.aws.ec2_instance_info:
        aws_access_key: "{{ec2_access_key}}"
        aws_secret_key: "{{ec2_secret_key}}"
        region: us-east-1
        filters:
          instance-state-name: ["running"]
      register: ec2_node_info
    - debug:
        msg: "{{ ec2_node_info.instances[0].public_ip_address }}"

    - name: Add new instance to host group
      add_host:
         hostname: "{{ ec2_node_info.instances[0].public_ip_address }}"
         ansible_ssh_host: micro-master
         ansible_ssh_port: 22
         inventory_dir: /var/jenkins_home/ansible/inventory.txt
         groupname: microk8s

    - name: Wait 300 seconds for port 22 to become open and contain "OpenSSH"
      wait_for:
        port: 22
        host: '{{ ec2_node_info.instances[0].public_ip_address }}'
        delay: 10
      vars:
        ansible_connection: local
      register: check_port_result
    - debug:
        msg: "{{ check_port_result }}"
